{layout name="common/header_footer" /}

<script src="__ROOT__/editor/lib/jquery/dist/jquery.js"></script>
<script src="__ROOT__/editor/lib/markdown-it/dist/markdown-it.js"></script>
<script src="__ROOT__/editor/lib/to-mark/dist/to-mark.js"></script>
<script src="__ROOT__/editor/lib/tui-code-snippet/dist/tui-code-snippet.js"></script>
<script src="__ROOT__/editor/lib/tui-color-picker/dist/tui-color-picker.js"></script>
<script src="__ROOT__/editor/lib/codemirror/lib/codemirror.js"></script>
<script src="__ROOT__/editor/lib/highlightjs/highlight.pack.js"></script>
<script src="__ROOT__/editor/lib/squire-rte/build/squire-raw.js"></script>
<link rel="stylesheet" href="__ROOT__/editor/lib/codemirror/lib/codemirror.css">
<link rel="stylesheet" href="__ROOT__/editor/lib/highlightjs/styles/github.css">
<link rel="stylesheet" href="__ROOT__/editor/explain.css">
<script src="__ROOT__/editor/lib/plantuml-encoder/dist/plantuml-encoder.js"></script>
<script src="__ROOT__/editor/lib/raphael/raphael.js"></script>
<script src="__ROOT__/editor/lib/tui-chart/dist/tui-chart.js"></script>
<script src="__ROOT__/editor/dist/tui-editor-Editor-all.js"></script>
<script src="__ROOT__/editor/dist/tui-editor-Editor.js"></script>
<link rel="stylesheet" href="__ROOT__/editor/dist/tui-editor.css">
<link rel="stylesheet" href="__ROOT__/editor/dist/tui-editor-contents.css">
<link rel="stylesheet" href="__ROOT__/editor/lib/tui-color-picker/dist/tui-color-picker.css">
<link rel="stylesheet" href="__ROOT__/editor/lib/tui-chart/dist/tui-chart.css">

<div class="layui-fluid">
    <div class="layui-card layui-tab-brief">
        <div class="layui-card-header layuiadmin-card-header-auto">
            <p>站点分类列表</p>
        </div>
        <ul class="layui-tab-title">
            <li class=""><a href="{:url('index')}">站点分类列表</a></li>
            <li class="layui-this">添加分类</li>
        </ul>

        <div class="layui-card-body">

            <form class="layui-form form-container" action="{:url('add')}" method="post">
                <div class="layui-form-item">
                    <label class="layui-form-label">分类名称</label>
                    <div class="layui-input-block">
                        <input type="text" name="cate_name" value="" required  lay-verify="required" placeholder="请输入分类名称" class="layui-input">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">状态</label>
                    <div class="layui-input-block">
                        <input type="radio" name="status" value="1" title="有效" checked="checked">
                        <input type="radio" name="status" value="0" title="无效">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">排序</label>
                    <div class="layui-input-block">
                        <input type="text" name="sort" value="0" required  lay-verify="required" class="layui-input">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">排序</label>
                    <div class="layui-input-block" id="editSection" name="content">

                    </div>
                </div>
                <div class="layui-form-item">
                    <div class="layui-input-block">
                        <button class="layui-btn" lay-submit lay-filter="*">保存</button>
                        <button type="reset" class="layui-btn layui-btn-primary">重置</button>
                    </div>
                </div>
            </form>
        </div>
        <button class="layui-btn" lay-submit lay-filter="*" id="haha">保存</button>

    </div>
</div>

<script>
    layui.use(['form', 'layedit', 'laydate']);
</script>
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/all.css" integrity="sha384-lKuwvrZot6UHsBSfcMvOkWwlCMgc0TaWr+30HWe3a4ltaBwTZhyTEggF5tJv8tbt" crossorigin="anonymous">
<script class="code-js">
    (function(root, factory) {
        if (typeof define === 'function' && define.amd) {
            define(['tui-editor'], factory);
        } else if (typeof exports === 'object') {
            factory(require('tui-editor'));
        } else {
            factory(root['tui']['Editor']);
        }
    })(this, function(Editor) {
        // define youtube extension
        Editor.defineExtension('youtube', function() {
            // runs while markdown-it transforms code block to HTML
            Editor.codeBlockManager.setReplacer('youtube', function(youtubeId) {
                // Indentify multiple code blocks
                var wrapperId = 'yt' + Math.random().toString(36).substr(2, 10);
                // avoid sanitizing iframe tag
                setTimeout(renderYoutube.bind(null, wrapperId, youtubeId), 0);

                return '<div id="' + wrapperId + '"></div>';
            });
        });
//https://o05g5zevc.qnssl.com/40bdda92-e29f-4606-81de-9d04254a4a1e/Despacito.mp4#t=11,280
        function renderYoutube(wrapperId, youtubeId) {
            var el = document.querySelector('#' + wrapperId);
            el.innerHTML = "<video  playsinline webkit-playsinline preload='auto' controls src='"+youtubeId+"' width='100%'  webkit-playsinline playsinline>如果你看到这段文字，说明视频挂掉。</video>";
        }
    });


    // https://nhnent.github.io/tui.editor/api/latest/ToastUIEditor.html#ToastUIEditor
    var editor = new tui.Editor({
        el: document.querySelector('#editSection'),
        previewStyle: 'vertical',
        height: '400px',
        initialEditType: 'markdown',
        useCommandShortcut: true,
        initialValue: '',
        hooks: {
            addImageBlobHook: addImageBlobHook.bind(this),
        },
        language: 'zh_CN',
        toolbarItems: [
            'heading',
            'bold',
            'italic',
            'strike',
            'divider',
            'hr',
            'quote',
            'divider',
            'ul',
            'ol',
            'task',
            'indent',
            'outdent',
            'divider',
            'table',
            'image',
            'link',
            'divider',
            'code',
            'codeblock',
            'divider'
            ],
        exts: [
            {
                name: 'chart',
                minWidth: 100,
                maxWidth: 600,
                minHeight: 100,
                maxHeight: 300
            },
            'scrollSync',
            'colorSyntax',
            'uml',
            'chart',
            'mark',
            'table',
            'video'
        ]
    });



    // ADD button method 2
    const toolbar = editor.getUI().getToolbar();

    editor.eventManager.addEventType('Event1');
    var html = "``` youtube" +"\n\n"+
        "```";

    // editor.setMarkdown(html,true);
    // editor.setValue(html,true);
    editor.setValue(html);
    });

    toolbar.addButton({
        name: 'customize',
        className: 'fab fa-accessible-icon',
        event: 'Event1',
        tooltip: 'Video',
        $el: $('<div class="our-button-class" style="display: inline-block;float: left;"><i class="fab fa-apple"></i></div>')
    }, 1);

    $('#haha').click(function(){
        var html = editor.getHtml();
        var markdown = editor.getMarkdown();
        alert(html);alert(markdown);
    });


    function addImageBlobHook(blob, callback) {
        const data = new FormData();
        //blob就是一个文件对象
        data.append('image', blob);
        //console.log(data, $('#cuzn123')[0]);
        //console.log 打印data的时候确实为空,要用下面的方法打印,然后看php获取的值,之前一直用get,拿不到值,换了post就好了
        //console.log(data.has("upfile"));//true
        console.log(data.get("image"));

        //data.forEach(function(file){
        //    console.log(file);
        //});

        $.ajax({
            url: "{:url('upload')}",
            type: "POST",
            data: data,
            //dataType: 'JSON',
            processData: false,
            contentType: false,
            //async: false,
            cache: false,
            //headers: {
            //    'Content-Type': 'multipart/form-data'
            //},
            success: function (result) {
                result = JSON.parse(result);
                console.log(typeof result);
                console.log("result['state'] : " + result["state"]);
                console.log("result.state : " + result.state);
                if (result["code"] == '1') {
                    //这里是生成htpp模式的图片地址(我这里是七牛返回的一个key,需要转换)
                    // var image = MyCommon.getViewImage(result["key"]);
                    var image = result['msg']['url'];
                    //这里是插件自带的回调函数
                    callback(image, 'alt text');
                }
                console.log(result);
            },
            error: function (e) {
                console.log(e);
            }
        });
        //$.get('/upload-images', data, config) .then(response => { callback(response.data.url, ''); }) .catch(error => { })
    }



    //提交表单之前 把值插入textarea 里面

    function subF() {

        $("#content").val(editor.getMarkdown ());

        //console.log('editor.getHtml () : ' + editor.getHtml ());

        //console.log('editor.getValue () : ' + editor.getValue ());

        //console.log('editor.getMarkdown () : ' + editor.getMarkdown ());

        return true;

    }

</script>